 ‚óã Compiling /api/follow-up/cancel ...
 ‚úì Compiled /api/follow-up/cancel in 1642ms
 POST /api/follow-up/cancel 200 in 2058ms
 ‚óã Compiling /api/follow-up ...
 ‚úì Compiled /api/follow-up in 719ms
MODO DE TESTE CONFIGURADO COMO: ATIVADO
Processador de mensagens personalizado configurado.
Sistema de follow-up inicializado com integra√ß√£o da API Lumibot.
 POST /api/follow-up 201 in 869ms
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Processando passo 0 (Etapa 1)
Modo de teste: convertendo tempo "30 minutos" para 30 segundos para testes
===== LOG DE AGENDAMENTO DE MENSAGEM =====
FollowUp ID: 100a684c-1b4b-4131-805a-956998b55f30
Step Index: 0
Cliente ID: 58
Conte√∫do: "Ei, Boss! üöÄ Vi que voc√™ recebeu a mensagem, mas ainda n√£o respondeu. Quer tirar alguma d√∫vida ante
Hor√°rio Agendado: 2025-03-25T00:09:33.624Z
Metadata: {
  "template_name": "novo_lead_10min",
  "category": "Utility",
  "stage_name": "Etapa 1",
  "clientName": "58",
  "templateParams": {
    "name": "novo_lead_10min",
    "category": "Utility",
    "language": "pt_BR"
  },
  "processedParams": {
    "1": "58"
  }
}
Atraso calculado: 29988ms (29.988 segundos)
Agendando mensagem para daqui a 29.988 segundos
Timeout armazenado com sucesso para mensagem 100a684c-1b4b-4131-805a-956998b55f30-0
Mensagem para o passo 0 agendada com sucesso
Pr√≥ximo passo: novo_lead_30min, tempo de espera: 30000ms
Agendando pr√≥ximo passo 1 para follow-up 100a684c-1b4b-4131-805a-956998b55f30 com delay de 30000ms
Recarregando 1 follow-ups ativos com mensagens pendentes
===== LOG DE AGENDAMENTO DE MENSAGEM =====
FollowUp ID: 100a684c-1b4b-4131-805a-956998b55f30
Step Index: 0
Cliente ID: 58
Conte√∫do: "Ei, Boss! üöÄ Vi que voc√™ recebeu a mensagem, mas ainda n√£o respondeu. Quer tirar alguma d√∫vida ante
Hor√°rio Agendado: 2025-03-25T00:09:33.624Z
Metadata: {
  "template_name": "novo_lead_10min",
  "category": "Utility",
  "stage_name": "Etapa 1"
}
Cancelando timeout existente para mensagem 100a684c-1b4b-4131-805a-956998b55f30-0
Atraso calculado: 27029ms (27.029 segundos)
Agendando mensagem para daqui a 27.029 segundos
Timeout armazenado com sucesso para mensagem 100a684c-1b4b-4131-805a-956998b55f30-0
Reagendado envio da mensagem do passo 0 para follow-up 100a684c-1b4b-4131-805a-956998b55f30
Executando timeout para mensagem 100a684c-1b4b-4131-805a-956998b55f30-0
===== LOG DE ENVIO DE MENSAGEM =====
FollowUp ID: 100a684c-1b4b-4131-805a-956998b55f30
Step Index: 0
Cliente ID: 58
Status do follow-up: active
Enviando mensagem via API Lumibot
Template: novo_lead_10min
Categoria: Utility
===== REQUISI√á√ÉO GET CONVERSA DO CLIENTE =====
Cliente ID: 58
Endpoint: https://app.lumibot.com.br/api/v1/accounts/10/conversations/58
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Processando passo 1 (Etapa 1)
Modo de teste: convertendo tempo "30 minutos" para 30 segundos para testes
===== LOG DE AGENDAMENTO DE MENSAGEM =====
FollowUp ID: 100a684c-1b4b-4131-805a-956998b55f30
Step Index: 1
Cliente ID: 58
Conte√∫do: Oi, {{1}}! Percebi que seu atendimento ainda est√° em andamento. Sei que a rotina pode ser corrida, e
Hor√°rio Agendado: 2025-03-25T00:10:03.672Z
Metadata: {
  "template_name": "novo_lead_30min",
  "category": "Utility",
  "stage_name": "Etapa 1",
  "clientName": "58",
  "templateParams": {
    "name": "novo_lead_30min",
    "category": "Utility",
    "language": "pt_BR"
  },
  "processedParams": {
    "1": "58"
  }
}
Atraso calculado: 29991ms (29.991 segundos)
Agendando mensagem para daqui a 29.991 segundos
Timeout armazenado com sucesso para mensagem 100a684c-1b4b-4131-805a-956998b55f30-1
Mensagem para o passo 1 agendada com sucesso
Follow-up 100a684c-1b4b-4131-805a-956998b55f30 - √öltimo passo do est√°gio, aguardando resposta antes de avan√ßar para Etapa 2
Follow-up 100a684c-1b4b-4131-805a-956998b55f30 - Preparando transi√ß√£o para o pr√≥ximo est√°gio: Etapa 2
Follow-up 100a684c-1b4b-4131-805a-956998b55f30 - Existem 2 mensagens pendentes no est√°gio "Etapa 1". Pausando para aguardar envio completo.
===== RESPOSTA GET CONVERSA DO CLIENTE =====
Status: 200
Detalhes do envio para Lumibot:
- clientId: 58
- templateName: novo_lead_10min
- category: Utility
===== RESPOSTA DA API LUMIBOT =====
Status: 200
Resultado do envio via Lumibot: SUCESSO
Atualizando mensagem como entregue no banco de dados
Mensagem marcada como entregue com sucesso
Timeout removido do mapa: 100a684c-1b4b-4131-805a-956998b55f30-0
Executando timeout para mensagem 100a684c-1b4b-4131-805a-956998b55f30-1
===== LOG DE ENVIO DE MENSAGEM =====
FollowUp ID: 100a684c-1b4b-4131-805a-956998b55f30
Step Index: 1
Cliente ID: 58
Status do follow-up: active
Enviando mensagem via API Lumibot
Template: novo_lead_30min
Categoria: Utility
===== REQUISI√á√ÉO GET CONVERSA DO CLIENTE =====
Cliente ID: 58
Endpoint: https://app.lumibot.com.br/api/v1/accounts/10/conversations/58
===== RESPOSTA GET CONVERSA DO CLIENTE =====
Status: 200
Detalhes do envio para Lumibot:
- clientId: 58
- templateName: novo_lead_30min
- category: Utility
===== RESPOSTA DA API LUMIBOT =====
Status: 200
Resultado do envio via Lumibot: SUCESSO
Atualizando mensagem como entregue no banco de dados
Mensagem marcada como entregue com sucesso
Todas as mensagens do est√°gio "Etapa 1" foram entregues, retomando transi√ß√£o de est√°gio
Timeout removido do mapa: 100a684c-1b4b-4131-805a-956998b55f30-1
Retomando transi√ß√£o de est√°gio para follow-up 100a684c-1b4b-4131-805a-956998b55f30 ap√≥s entrega de todas as mensagens
Erro ao avan√ßar automaticamente ap√≥s entrega de mensagens: TypeError: advanceToNextStage is not a function
    at Timeout._onTimeout (app/api/follow-up/_lib/scheduler.ts:306:26)
  304 |                     // Importar apenas advanceToNextStage para evitar erros circulares
  305 |                     const { advanceToNextStage } = await import('./manager');
> 306 |                     await advanceToNextStage(message.followUpId);
      |                          ^
  307 |                   } else {
  308 |                     console.log(`Follow-up ${message.followUpId} n√£o est√° mais ativo, n√£o avan√ßando automaticamente`);
  309 |                   }
 ‚óã Compiling /api/follow-up/client-response ...
 ‚úì Compiled /api/follow-up/client-response in 615ms
=== DADOS DA RESPOSTA DO CLIENTE ===
followUpId: 100a684c-1b4b-4131-805a-956998b55f30
clientId: 58
message: Ol√°, estou testando o avan√ßo de est√°gio!
=== FIM DADOS DA RESPOSTA DO CLIENTE ===
=== DADOS DA RESPOSTA DO CLIENTE ===
{
  followUpId: '100a684c-1b4b-4131-805a-956998b55f30',
  clientId: '58',
  message: 'Ol√°, estou testando o avan√ßo de est√°gio!'
}
=== FIM DADOS DA RESPOSTA DO CLIENTE ===
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Est√°gio atual: Etapa 1 √≠ndice: 0
Cliente respondeu durante follow-up ativo. Avan√ßando para pr√≥ximo est√°gio: Etapa 2
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Modo de teste: reduzindo tempo de espera de 1800000ms para 30 segundos
Processando passo 2 (Etapa 2)
Modo de teste: convertendo tempo "30 minutos" para 30 segundos para testes
===== LOG DE AGENDAMENTO DE MENSAGEM =====
FollowUp ID: 100a684c-1b4b-4131-805a-956998b55f30
Step Index: 2
Cliente ID: 58
Conte√∫do: Oi, {{1}}! Vi que voc√™ iniciou um processo conosco, mas ainda n√£o conclu√≠mos sua qualifica√ß√£o. Caso 
Hor√°rio Agendado: 2025-03-25T00:10:40.475Z
Metadata: {
  "template_name": "qualificacao_10min",
  "category": "Utility",
  "stage_name": "Etapa 2",
  "clientName": "58",
  "templateParams": {
    "name": "qualificacao_10min",
    "category": "Utility",
    "language": "pt_BR"
  },
  "processedParams": {
    "1": "58"
  }
}
Atraso calculado: 29995ms (29.995 segundos)
Agendando mensagem para daqui a 29.995 segundos
Timeout armazenado com sucesso para mensagem 100a684c-1b4b-4131-805a-956998b55f30-2
Mensagem para o passo 2 agendada com sucesso
Pr√≥ximo passo: qualificacao_1h, tempo de espera: 30000ms
Agendando pr√≥ximo passo 3 para follow-up 100a684c-1b4b-4131-805a-956998b55f30 com delay de 30000ms
 POST /api/follow-up/client-response 200 in 764ms
 ‚úì Compiled /api/follow-up/status in 485ms
 GET /api/follow-up/status?id=100a684c-1b4b-4131-805a-956998b55f30 200 in 533ms